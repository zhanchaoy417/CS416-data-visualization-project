<!DOCTYPE html>
<html> 

<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<head> 
    <title> Narrative Visualization COVID-19 Deaths and Casess </title>

</head>

<body onload="init()">

    <h1 style="text-align: left;"> NewYork Daily COVID-19 Deaths Count </h1>
    <p>The chart below shows the statistics of daily deaths in NewYork in 2020. 
        It can be seen that the peak period is mid-April, and about 1000 people die every day.</p>
    <div id="chart"></div><script>

//create get_data function include filter state, count cases/deaths, sorting 
        function get_data(data, keyword) {
            var filtered_data = data.filter(function(d){   
                                    return d.state===keyword;
                                        });

            fetch_data = filtered_data.map(function(d) { 
                    return { 
                        state: d.state,
                        date: new Date(d.date), 
                        new_deaths: d['daily deaths']
                    }
            })

            var compareDates = function(a, b) {
                    return d3.ascending(a.date, b.date);
                        };
            return fetch_data.sort(compareDates);

        }

        const width = 800;
        const height = 400;
        const margin = { top: 40, right: 40, bottom: 60, left: 80 };

        // Create an SVG element
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);
        
            //make annotation groups, make 3 annotation for peak time
            svg.append("g")
            .attr("class", "annotation1");

            svg.append("g")
            .attr("class", "annotation2");

            svg.append("g")
            .attr("class", "annotation3");

        async function init() { 
            const data = await d3.csv("us-states-2020.csv");

                var keyword = "New York"
                fetch_data = get_data(data, keyword);
            
       //append x and y axis temporary
         svg.append("g")
            .attr("transform", "translate("+0+", "+height+")")
            .attr("class", "x_axis");  

        svg.append("g")
            .attr("class", "y_axis");

     // set up xScale and yScale for next setp
            const xScale = d3.scaleTime()
                     .domain(d3.extent(data, d => new Date(d.date) ))
                     .range([0, width]);

            var max_deaths = d3.max(fetch_data, d=> +d.new_deaths); 
            //var min_deaths = d3.min(fetch_data, d=> +d.new_deaths);

            const yScale = d3.scaleLinear()
                        .domain([0, max_deaths])
                        .range([height, 0]); 
          
        //append x and y axis with time effect
            svg.selectAll(".x_axis").transition()
                     .duration(3000)
                    .call(d3.axisBottom(xScale));

            svg.selectAll(".y_axis").transition()
                    .duration(2000)
                   .call(d3.axisLeft(yScale));

                // Set the gradient 
                //(code taken from: https://www.d3-graph-gallery.com/graph/line_color_gradient_svg.html)
                d3.select("svg").append("linearGradient")
                .attr("id", "line-gradient")
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", 0)
                .attr("y1", yScale(0))
                .attr("x2", 0)
                .attr("y2", yScale(max_deaths))
                .selectAll("stop")
                    .data([
                    {offset: "0%", color: "blue"},
                    {offset: "100%", color: "orange"}
                    ])
                .enter().append("stop")
                    .attr("offset", function(d) { return d.offset; })
                    .attr("stop-color", function(d) { return d.color; })
           
            // Add the line
               svg.selectAll(".chart_line")
                    .data([fetch_data], function(d) { return d.date })
                    .join("path")
                    .attr('stroke', 'url(#line-gradient') 
                        .attr('fill', 'none')
                        .attr('stroke-width', '2')
                        .attr('d', d3.line()
                            .x(function(d) { return xScale(d.date); })
                            .y(function(d) { return yScale(d.new_deaths); }));
               
                // Chart labels
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom)
                    .attr("text-anchor", "middle")
                    .text("Date  (Year 2020)");

                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 10 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("# Deaths");
//code form https://d3-annotation.susielu.com/
//annotationCalloutCircle: radius or outerRadius and innerRadius: Number, pixels, radiusPadding: Number, pixels
            const type = d3.annotationCalloutCircle
                // Features of the annotation
                const annotation1 = [
                {
                    note: {
                        label: 
                        "The first peak of COVID-19 in year 2020, about 1000 daily deaths at that time",
                        bgPadding: 20,
                        title: "First Peak"
                    },
                    x: 220,
                    y: 0,
                    dy: 0,
                    dx: -10,
                    subject: {
                        radius: 30,
                        radiusPadding: 5
                    }   
                }]

                const makeAnnotations1 = d3.annotation()
                .notePadding(15)
                    .type(type)
                    .annotations(annotation1);

        //append annotation text
                svg.selectAll(".annotation1")
                    .append("g")
                    .style("font-size", 15)
                    .call(makeAnnotations1);

                    const annotation2 = [
                {
                    note: {
                        label: "The second peak of COVID-19 in year 2020, about 30 daily deaths at that time",
                        bgPadding: 20,
                        title: "Second Peak"
                    },
                    x: 310,
                    y: 50,
                    dy: 0,
                    dx: 30,
                    subject: {
                        radius: 30,
                        radiusPadding: 5
                    }   
                }]
                const makeAnnotations2 = d3.annotation()
                .notePadding(15)
                    .type(type)
                    .annotations(annotation2);

                svg.selectAll(".annotation2")
                    .append("g")
                    .style("font-size", 15)
                    .call(makeAnnotations2);

                    const annotation3 = [
                {
                    note: {
                        label: "The third peak of COVID-19 in year 2020, about 600 daily deaths at that time",
                        bgPadding: 10,
                        title: "Third Peak"
                    },
                    x: 470,
                    y: 200,
                    dy: 0,
                    dx: 50,
                    subject: {
                        radius: 30,
                        radiusPadding: 5
                    }   
                }]
                const makeAnnotations3 = d3.annotation()
                .notePadding(15)
                    .type(type)
                    .annotations(annotation3);

                svg.selectAll(".annotation2")
                    .append("g")
                    .style("font-size", 15)
                    .call(makeAnnotations3);

           
        }
     
    </script>

<div class="pagination">
    <a href="COVID19_2020_daily_deaths_CO.html">&laquo;</a>
    <a  href="COVID19_2020_daily_deaths_US.html">Overview Chart</a>
    <a  href="COVID19_2020_daily_deaths_CA.html">1</a>
    <a  href="COVID19_2020_daily_deaths_CO.html">2</a>
    <a class="active" href="COVID19_2020_daily_deaths_NY.html">3</a>
    <a href="COVID19_2020_daily_cases_Bystate.html">4</a>
    <a href="COVID19_2020_daily_cases_Bystate.html">&raquo;</a>
    
</div>
<style>
  
    .pagination a {
        
        color: black;
        float: left;
        padding: 20px 32px;
    }
    
    .pagination a.active {
    background-color: dodgerblue;
    color: white;
    }
    p {
      font-size: 24px; /* Set the font size to make the text bigger */
    }
   
    

</style>

</body>

</html>
